name: Deploy to Firebase

on:
  push:
    branches:
      - master
  workflow_dispatch: # Allow manual trigger from GitHub UI

env:
  NODE_VERSION: '20'
  FIREBASE_PROJECT: hasod-41a23

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      # ============================================
      # Setup
      # ============================================
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # ============================================
      # API Spec - Validate & Generate Types
      # ============================================
      - name: Validate OpenAPI spec
        run: npm run api:validate

      - name: Generate TypeScript types from OpenAPI
        run: npm run api:generate

      - name: Verify generated types exist
        run: |
          if [ ! -f "packages/webapp/src/api/schema.d.ts" ]; then
            echo "Error: Generated types file not found!"
            exit 1
          fi
          echo "Generated types file exists"

      # ============================================
      # Build All Packages
      # ============================================
      - name: Build shared package
        run: npm run build:shared

      - name: Build webapp
        run: npm run build:webapp

      - name: Build functions
        run: npm run build:functions

      # ============================================
      # Prepare Functions Environment
      # ============================================
      - name: Create functions environment config
        run: |
          cat > packages/functions/.env.yaml << EOF
          PAYPAL_CLIENT_ID: "${{ secrets.PAYPAL_CLIENT_ID }}"
          PAYPAL_CLIENT_SECRET: "${{ secrets.PAYPAL_CLIENT_SECRET }}"
          PAYPAL_SANDBOX: "false"
          GOOGLE_SERVICE_ACCOUNT_KEY: '${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}'
          GOOGLE_ADMIN_EMAIL: "hasod@hasodonline.com"
          OPENAI_API_KEY: "${{ secrets.OPENAI_API_KEY }}"
          DEEZER_ARL: "${{ secrets.DEEZER_ARL }}"
          EOF

      # ============================================
      # Deploy to Firebase
      # ============================================
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy Hosting
        run: firebase deploy --only hosting --project ${{ env.FIREBASE_PROJECT }} --non-interactive

      - name: Deploy Cloud Functions
        run: firebase deploy --only functions --project ${{ env.FIREBASE_PROJECT }} --non-interactive

      - name: Deploy Firestore Rules
        run: firebase deploy --only firestore:rules --project ${{ env.FIREBASE_PROJECT }} --non-interactive

      # ============================================
      # Post-Deployment Verification
      # ============================================
      - name: Verify deployment
        run: |
          echo "Deployment complete!"
          echo "Webapp: https://${{ env.FIREBASE_PROJECT }}.web.app"
          echo "API: https://us-central1-${{ env.FIREBASE_PROJECT }}.cloudfunctions.net/api"

      - name: Health check - API
        run: |
          sleep 10  # Wait for functions to be available
          curl -f "https://us-central1-${{ env.FIREBASE_PROJECT }}.cloudfunctions.net/api/services" || echo "API health check failed (may need more time)"
